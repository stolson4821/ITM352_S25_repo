<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistical Analysis Tool</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .analysis-container {
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .plot-container img {
            max-width: 100%;
            height: auto;
        }
        .column-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .column-group h6 {
            margin-bottom: 10px;
            color: #555;
        }
        .validation-message {
            display: none;
            margin-top: 10px;
        }
        .result-image {
            max-width: 100%;
            margin-bottom: 20px;
        }
        .table-responsive {
            margin-bottom: 20px;
        }
        .select2-container {
            width: 100% !important;
        }
        .select2-selection--multiple {
            min-height: 38px !important;
        }
        .badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .badge.numeric {
            background-color: #0d6efd;
        }
        .badge.categorical {
            background-color: #fd7e14;
        }
        .analysis-card {
            transition: transform 0.2s;
        }
        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .card-header h5 {
            margin-bottom: 0;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 14px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 0;
        }
        .step {
            background: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }
        .step.active {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }
        .step.completed {
            border-color: #198754;
            background: #198754;
            color: white;
        }
        .dependent-option {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1 class="text-center mb-4">Statistical Analysis Tool</h1>
        
        <!-- Step Indicator -->
        <div class="step-indicator mb-4">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <!-- File Upload Section -->
        <div class="card mb-4" id="uploadSection">
            <div class="card-header bg-primary text-white">
                <h5>Upload Data File</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Select CSV File</label>
                        <input class="form-control" type="file" id="csvFile" name="file" accept=".csv">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>

        <!-- Analysis Menu -->
        <div id="analysisMenu" class="card mb-4" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5>Select Analysis Type</h5>
            </div>
            <div class="card-body">
                <div class="row row-cols-1 row-cols-md-2 g-4">
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="descriptive_statistics">
                            <div class="card-body">
                                <h5 class="card-title">Descriptive Statistics</h5>
                                <p class="card-text">Analyze key statistical measures of numeric data.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="scatter_matrix">
                            <div class="card-body">
                                <h5 class="card-title">Scatter Matrix</h5>
                                <p class="card-text">Visualize relationships between multiple numeric variables.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="linear_regression">
                            <div class="card-body">
                                <h5 class="card-title">Linear Regression (Single)</h5>
                                <p class="card-text">Model the relationship between variables.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="multiple_regression">
                            <div class="card-body">
                                <h5 class="card-title">Multiple Regression</h5>
                                <p class="card-text">Model with multiple independent variables.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="polynomial_regression">
                            <div class="card-body">
                                <h5 class="card-title">Polynomial Regression</h5>
                                <p class="card-text">Model non-linear relationships.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="logistic_regression">
                            <div class="card-body">
                                <h5 class="card-title">Logistic Regression</h5>
                                <p class="card-text">Model binary outcomes.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="anova">
                            <div class="card-body">
                                <h5 class="card-title">ANOVA</h5>
                                <p class="card-text">Compare means across groups.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="chi_square">
                            <div class="card-body">
                                <h5 class="card-title">Chi-Square Test</h5>
                                <p class="card-text">Test for association between categorical variables.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="correlation">
                            <div class="card-body">
                                <h5 class="card-title">Correlation Heatmap</h5>
                                <p class="card-text">Measure relationships between variables.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="pca">
                            <div class="card-body">
                                <h5 class="card-title">PCA Analysis</h5>
                                <p class="card-text">Reduce dimensionality while preserving variance.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="clustering">
                            <div class="card-body">
                                <h5 class="card-title">Clustering (KMeans)</h5>
                                <p class="card-text">Group similar data points into clusters.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 analysis-card" data-analysis="residual_diagnostics">
                            <div class="card-body">
                                <h5 class="card-title">Residual Diagnostics</h5>
                                <p class="card-text">Validate regression model assumptions.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Column Selection Section -->
        <div id="columnSelection" class="card mb-4" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5 id="selectionTitle">Select Variables</h5>
            </div>
            <div class="card-body">
                <p id="analysisDescription" class="text-muted mb-4"></p>
                
                <form id="columnsForm">
                    <div id="variableSelections" class="mb-4">
                        <!-- Dynamic variable selection panels will be inserted here -->
                    </div>
                    
                    <div id="additionalOptions" class="mb-4">
                        <!-- Additional options will be inserted here -->
                    </div>
                    
                    <div id="validationMessage" class="alert alert-warning validation-message mb-4"></div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToMenu">Back</button>
                        <button type="submit" class="btn btn-primary">Run Analysis</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing analysis...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" class="card mb-4" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 id="resultsTitle">Analysis Results</h5>
            </div>
            <div class="card-body">
                <div id="resultsContent"></div>
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" id="backToVariables">Back to Variables</button>
                    <button type="button" class="btn btn-primary" id="newAnalysis">New Analysis</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Store column metadata
            let columnData = {
                numeric: [],
                categorical: []
            };
            
            // Current analysis type
            let currentAnalysis = '';
            
            // Analysis requirements
            const analysisRequirements = {
                descriptive_statistics: {
                    description: "This analysis provides key statistical measures (mean, median, standard deviation, etc.) for selected numeric variables.",
                    variables: [
                        {
                            id: "numeric_vars",
                            label: "Numeric Variables",
                            type: "numeric",
                            multiple: true,
                            min: 1,
                            description: "Select one or more numeric variables to analyze"
                        }
                    ],
                    options: [
                        {
                            id: "filter_rows",
                            label: "Filter by Row Range",
                            type: "checkbox",
                            default: false,
                            description: "Limit analysis to a specific range of rows"
                        },
                        {
                            id: "start_row",
                            label: "Start Row",
                            type: "number",
                            min: 0,
                            default: 0,
                            parentControl: "filter_rows",
                            description: "Starting row index (inclusive)"
                        },
                        {
                            id: "end_row",
                            label: "End Row",
                            type: "number",
                            min: 1,
                            default: 100,
                            parentControl: "filter_rows",
                            description: "Ending row index (exclusive)"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.numeric_vars && selected.numeric_vars.length >= 1;
                        
                        if (isValid && selected.filter_rows) {
                            const startRow = parseInt(selected.start_row || 0);
                            const endRow = parseInt(selected.end_row || 0);
                            
                            if (endRow <= startRow) {
                                $('#validationMessage').text('End row must be greater than start row').show();
                                return false;
                            }
                        }
                        
                        return isValid;
                    }
                },
                scatter_matrix: {
                    description: "This creates a matrix of scatter plots to visualize relationships between multiple numeric variables.",
                    variables: [
                        {
                            id: "numeric_vars",
                            label: "Numeric Variables",
                            type: "numeric",
                            multiple: true,
                            min: 2,
                            description: "Select two or more numeric variables"
                        }
                    ],
                    validate: function(selected) {
                        return selected.numeric_vars && selected.numeric_vars.length >= 2;
                    }
                },
                linear_regression: {
                    description: "Linear regression models the relationship between one independent variable and a dependent variable.",
                    variables: [
                        {
                            id: "dependent_var",
                            label: "Dependent Variable (Y)",
                            type: "numeric",
                            multiple: false,
                            description: "The variable you want to predict"
                        },
                        {
                            id: "independent_var",
                            label: "Independent Variable (X)",
                            type: "numeric",
                            multiple: false,
                            description: "The predictor variable"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.dependent_var && selected.independent_var;
                        
                        if (isValid && selected.dependent_var === selected.independent_var) {
                            $('#validationMessage').text('The dependent variable cannot also be an independent variable').show();
                            return false;
                        }
                        
                        return isValid;
                    }
                },
                multiple_regression: {
                    description: "Multiple regression models the relationship between multiple independent variables and one dependent variable.",
                    variables: [
                        {
                            id: "dependent_var",
                            label: "Dependent Variable (Y)",
                            type: "numeric",
                            multiple: false,
                            description: "The variable you want to predict"
                        },
                        {
                            id: "independent_vars",
                            label: "Independent Variables (X)",
                            type: "numeric",
                            multiple: true,
                            min: 1,
                            description: "The predictor variables (at least 1)"
                        }
                    ],
                    options: [
                        {
                            id: "include_diagnostics",
                            label: "Include Diagnostics",
                            type: "checkbox",
                            default: false,
                            description: "Include detailed model diagnostics in results"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.dependent_var && 
                               selected.independent_vars && 
                               selected.independent_vars.length >= 1;
                        
                        if (isValid && selected.independent_vars.includes(selected.dependent_var)) {
                            $('#validationMessage').text('The dependent variable cannot also be an independent variable').show();
                            return false;
                        }
                        
                        return isValid;
                    }
                },
                polynomial_regression: {
                    description: "Polynomial regression models non-linear relationships by including polynomial terms.",
                    variables: [
                        {
                            id: "dependent_var",
                            label: "Dependent Variable (Y)",
                            type: "numeric",
                            multiple: false,
                            description: "The variable you want to predict"
                        },
                        {
                            id: "independent_var",
                            label: "Independent Variable (X)",
                            type: "numeric",
                            multiple: false,
                            description: "The predictor variable"
                        }
                    ],
                    options: [
                        {
                            id: "degree",
                            label: "Polynomial Degree",
                            type: "number",
                            min: 1,
                            max: 10,
                            default: 2,
                            description: "Higher values model more complex relationships (1=linear, 2=quadratic, 3=cubic, etc.)"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.dependent_var && 
                               selected.independent_var && 
                               selected.degree >= 1 && 
                               selected.degree <= 10;
                        
                        if (isValid && selected.dependent_var === selected.independent_var) {
                            $('#validationMessage').text('The dependent variable cannot also be an independent variable').show();
                            return false;
                        }
                        
                        return isValid;
                    }
                },
                logistic_regression: {
                    description: "Logistic regression models binary outcomes based on one or more predictor variables.",
                    variables: [
                        {
                            id: "dependent_var",
                            label: "Dependent Variable (Y)",
                            type: "both",
                            multiple: false,
                            description: "The binary outcome variable"
                        },
                        {
                            id: "independent_vars",
                            label: "Independent Variables (X)",
                            type: "numeric",
                            multiple: true,
                            min: 1,
                            description: "The predictor variables (at least 1)"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.dependent_var && 
                               selected.independent_vars && 
                               selected.independent_vars.length >= 1;
                        
                        if (isValid && selected.independent_vars.includes(selected.dependent_var)) {
                            $('#validationMessage').text('The dependent variable cannot also be an independent variable').show();
                            return false;
                        }
                        
                        return isValid;
                    }
                },
                anova: {
                    description: "ANOVA (Analysis of Variance) compares means across groups to detect significant differences.",
                    variables: [
                        {
                            id: "dependent_var",
                            label: "Dependent Variable",
                            type: "numeric",
                            multiple: false,
                            description: "The numeric variable to compare across groups"
                        },
                        {
                            id: "grouping_var",
                            label: "Grouping Variable",
                            type: "both",
                            multiple: false,
                            description: "The categorical variable or numeric with low cardinality that defines your groups"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.dependent_var && selected.grouping_var;
                        
                        if (isValid && selected.dependent_var === selected.grouping_var) {
                            $('#validationMessage').text('The dependent variable should be different from the grouping variable').show();
                            return false;
                        }
                        
                        return isValid;
                    }
                },
                chi_square: {
                    description: "Chi-Square test examines if there is a significant association between two categorical variables (or numeric with low cardinality).",
                    variables: [
                        {
                            id: "var1",
                            label: "First Variable",
                            type: "both",
                            multiple: false,
                            description: "First categorical variable"
                        },
                        {
                            id: "var2",
                            label: "Second Variable",
                            type: "both",
                            multiple: false,
                            description: "Second categorical variable"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.var1 && selected.var2;
                        
                        if (isValid && selected.var1 === selected.var2) {
                            $('#validationMessage').text('Please select two different variables for Chi-Square test').show();
                            return false;
                        }
                        
                        return isValid;
                    }
                },
                correlation: {
                    description: "Correlation analysis measures the strength and direction of relationships between pairs of variables.",
                    variables: [
                        {
                            id: "numeric_vars",
                            label: "Numeric Variables",
                            type: "numeric",
                            multiple: true,
                            min: 2,
                            description: "Select two or more numeric variables"
                        }
                    ],
                    options: [
                        {
                            id: "method",
                            label: "Correlation Method",
                            type: "select",
                            options: [
                                { value: "pearson", label: "Pearson (linear)" },
                                { value: "spearman", label: "Spearman (monotonic)" },
                                { value: "kendall", label: "Kendall (ordinal)" }
                            ],
                            default: "pearson",
                            description: "The method to calculate correlations"
                        }
                    ],
                    validate: function(selected) {
                        return selected.numeric_vars && 
                               selected.numeric_vars.length >= 2;
                    }
                },
                pca: {
                    description: "Principal Component Analysis (PCA) reduces dimensionality while preserving variance in the data.",
                    variables: [
                        {
                            id: "numeric_vars",
                            label: "Numeric Variables",
                            type: "numeric",
                            multiple: true,
                            min: 2,
                            description: "Select two or more numeric variables"
                        }
                    ],
                    options: [
                        {
                            id: "n_components",
                            label: "Number of Components",
                            type: "number",
                            min: 2,
                            max: 10,
                            default: 2,
                            description: "Number of principal components to calculate"
                        }
                    ],
                    validate: function(selected) {
                        return selected.numeric_vars && 
                               selected.numeric_vars.length >= 2;
                    }
                },
                clustering: {
                    description: "KMeans clustering groups similar data points into clusters based on selected features.",
                    variables: [
                        {
                            id: "numeric_vars",
                            label: "Features for Clustering",
                            type: "numeric",
                            multiple: true,
                            min: 2,
                            description: "Select two or more numeric variables"
                        }
                    ],
                    options: [
                        {
                            id: "n_clusters",
                            label: "Number of Clusters (k)",
                            type: "number",
                            min: 2,
                            max: 10,
                            default: 3,
                            description: "The number of clusters to form"
                        }
                    ],
                    validate: function(selected) {
                        return selected.numeric_vars && 
                               selected.numeric_vars.length >= 2 && 
                               selected.n_clusters >= 2 &&
                               selected.n_clusters <= 10;
                    }
                },
                residual_diagnostics: {
                    description: "Analyzes regression residuals to validate model assumptions such as normality and homoscedasticity.",
                    variables: [
                        {
                            id: "dependent_var",
                            label: "Dependent Variable (Y)",
                            type: "numeric",
                            multiple: false,
                            description: "The variable you want to predict"
                        },
                        {
                            id: "independent_vars",
                            label: "Independent Variables (X)",
                            type: "numeric",
                            multiple: true,
                            min: 1,
                            description: "The predictor variables (at least 1)"
                        }
                    ],
                    validate: function(selected) {
                        let isValid = selected.dependent_var && 
                               selected.independent_vars && 
                               selected.independent_vars.length >= 1;
                        
                        if (isValid && selected.independent_vars.includes(selected.dependent_var)) {
                            $('#validationMessage').text('The dependent variable cannot also be an independent variable').show();
                            return false;
                        }
                        
                        return isValid;
                    }
                }
            };
            
            // Update step indicator
            function updateStepIndicator(step) {
                $('.step').removeClass('active completed');
                for (let i = 1; i < step; i++) {
                    $(`#step${i}`).addClass('completed');
                }
                $(`#step${step}`).addClass('active');
            }
            
            // Initialize Select2 for a dropdown
            function initializeSelect2(element) {
                $(element).select2({
                    placeholder: "Select variables",
                    allowClear: true,
                    width: '100%'
                });
            }
            
            // Upload CSV
            $('#uploadForm').on('submit', function(e) {
                e.preventDefault();
                let formData = new FormData(this);
                
                $.ajax({
                    url: '/upload',
                    method: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    beforeSend: () => {
                        $('#uploadStatus').html('<div class="alert alert-info">Uploading and processing file...</div>');
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#uploadStatus').html('<div class="alert alert-success">' + response.message + '</div>');
                            $('#analysisMenu').show();

                            // Store column metadata
                            columnData.numeric = response.data.numeric_columns || [];
                            columnData.categorical = response.data.categorical_columns || [];
                            
                            // Display summary of uploaded data
                            let dataOverview = `
                                <div class="mt-4">
                                    <h6>Data Overview:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">Numeric Variables (${columnData.numeric.length})</h6>
                                                    <div>
                                                        ${columnData.numeric.map(col => `<span class="badge numeric">${col}</span>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">Categorical Variables (${columnData.categorical.length})</h6>
                                                    <div>
                                                        ${columnData.categorical.map(col => `<span class="badge categorical">${col}</span>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            $('#uploadStatus').append(dataOverview);
                            
                            // Show analysis menu
                            setTimeout(() => {
                                $('#uploadSection').hide();
                                $('#analysisMenu').show();
                                updateStepIndicator(2);
                            }, 1000);
                        } else {
                            $('#uploadStatus').html('<div class="alert alert-danger">' + response.message + '</div>');
                        }
                    },
                    error: function() {
                        $('#uploadStatus').html('<div class="alert alert-danger">Error uploading file. Please try again.</div>');
                    }
                });
            });
        
            // Build variable selection fields
            function buildVariableSelections(analysisType) {
                const requirements = analysisRequirements[analysisType];
                const selectionPanel = $('#variableSelections').empty();
                
                // Add variable selection fields
                if (requirements.variables) {
                    requirements.variables.forEach(variable => {
                        const options = [];
                        
                        if (variable.type === "numeric") {
                            columnData.numeric.forEach(col => {
                                options.push(`<option value="${col}">${col}</option>`);
                            });
                        } else if (variable.type === "categorical") {
                            columnData.categorical.forEach(col => {
                                options.push(`<option value="${col}">${col}</option>`);
                            });
                        } else if (variable.type === "both") {
                            // For categorical variables and numeric with low cardinality
                            columnData.categorical.forEach(col => {
                                options.push(`<option value="${col}">${col} (categorical)</option>`);
                            });
                            
                            columnData.numeric.forEach(col => {
                                options.push(`<option value="${col}">${col} (numeric)</option>`);
                            });
                        }
                        
                        const selectMultiple = variable.multiple ? 'multiple="multiple"' : '';
                        const requiredText = variable.min ? `(at least ${variable.min})` : '';
                        
                        selectionPanel.append(`
                            <div class="mb-4">
                                <label class="form-label">${variable.label} ${requiredText}</label>
                                <select class="form-control variable-select" id="${variable.id}" name="${variable.id}" ${selectMultiple} data-min="${variable.min || 0}">
                                    ${!variable.multiple ? '<option value="">-- Select --</option>' : ''}
                                    ${options.join('')}
                                </select>
                                <small class="form-text text-muted">${variable.description}</small>
                            </div>
                        `);
                        
                        // Initialize Select2 for this dropdown
                        initializeSelect2(`#${variable.id}`);
                    });
                }
                
                // Add additional options
                const additionalOptions = $('#additionalOptions').empty();
                
                if (requirements.options) {
                    requirements.options.forEach(option => {
                        // Check if this option depends on another control
                        const parentControlClass = option.parentControl ? 'dependent-option' : '';
                        const parentControlAttr = option.parentControl ? `data-parent="${option.parentControl}"` : '';
                        
                        const optionHTML = $(`<div class="mb-4 ${parentControlClass}" ${parentControlAttr}></div>`);
                        
                        if (option.type === "select") {
                            optionHTML.append(`
                                <label class="form-label">${option.label}</label>
                                <select class="form-control" id="${option.id}" name="${option.id}">
                                    ${option.options.map(opt => 
                                        `<option value="${opt.value}" ${opt.value === option.default ? 'selected' : ''}>${opt.label}</option>`
                                    ).join('')}
                                </select>
                                <small class="form-text text-muted">${option.description}</small>
                            `);
                        } else if (option.type === "number") {
                            optionHTML.append(`
                                <label class="form-label">${option.label}</label>
                                <input type="number" class="form-control" id="${option.id}" name="${option.id}" 
                                    value="${option.default}" min="${option.min}" max="${option.max || ''}" ${option.step ? `step="${option.step}"` : ''}>
                                <small class="form-text text-muted">${option.description}</small>
                            `);
                        } else if (option.type === "checkbox") {
                            optionHTML.append(`
                                <div class="form-check">
                                    <input class="form-check-input control-toggle" type="checkbox" id="${option.id}" name="${option.id}" ${option.default ? 'checked' : ''}>
                                    <label class="form-check-label" for="${option.id}">
                                        ${option.label}
                                    </label>
                                </div>
                                <small class="form-text text-muted">${option.description}</small>
                            `);
                        }
                        
                        additionalOptions.append(optionHTML);
                    });
                    
                    // Handle dependent options
                    $('.control-toggle').on('change', function() {
                        const controlId = $(this).attr('id');
                        if ($(this).is(':checked')) {
                            $(`[data-parent="${controlId}"]`).slideDown();
                        } else {
                            $(`[data-parent="${controlId}"]`).slideUp();
                        }
                    });
                    
                    // Initialize any checkboxes that are checked by default
                    $('.control-toggle').each(function() {
                        const controlId = $(this).attr('id');
                        if ($(this).is(':checked')) {
                            $(`[data-parent="${controlId}"]`).show();
                        } else {
                            $(`[data-parent="${controlId}"]`).hide();
                        }
                    });
                }
                
                // Add required fields validation
                $('select.variable-select').on('change', function() {
                    validateSelections();
                });
            }
            
            function getFormValues() {
                const values = {};
                
                // Get all select values
                $('#columnsForm select').each(function() {
                    const name = $(this).attr('name');
                    const value = $(this).val();
                    values[name] = value;
                });
                
                // Get all checkbox values
                $('#columnsForm input[type="checkbox"]').each(function() {
                    const name = $(this).attr('name');
                    values[name] = $(this).is(':checked');
                });
                
                // Get all number input values
                $('#columnsForm input[type="number"]').each(function() {
                    const name = $(this).attr('name');
                    values[name] = $(this).val();
                });
                
                return values;
            }
            
            function validateSelections() {
                const requirements = analysisRequirements[currentAnalysis];
                $('#validationMessage').hide();
                
                if (!requirements) return false;
                
                const formValues = getFormValues();
                return requirements.validate(formValues);
            }
            
            // Select analysis type
            $('.analysis-card').on('click', function() {
                const analysis = $(this).data('analysis');
                currentAnalysis = analysis;
                const requirements = analysisRequirements[analysis];
                
                $('#analysisMenu').hide();
                $('#columnSelection').show();
                updateStepIndicator(3);
                
                // Set title and description
                $('#selectionTitle').text('Select Variables for ' + $(this).find('.card-title').text());
                $('#analysisDescription').text(requirements.description);
                
                // Build variable selection fields
                buildVariableSelections(analysis);
                
                // Reset validation message
                $('#validationMessage').hide();
                
                // Add analysis type to form
                $('#columnsForm').data('analysis', analysis);
            });
            
            // Back to menu button
            $('#backToMenu').on('click', function() {
                $('#columnSelection').hide();
                $('#analysisMenu').show();
                updateStepIndicator(2);
            });
            
            // Back to variables from results
            $('#backToVariables').on('click', function() {
                $('#resultsContainer').hide();
                $('#columnSelection').show();
            });
            
            // New analysis button
            $('#newAnalysis').on('click', function() {
                $('#resultsContainer').hide();
                $('#analysisMenu').show();
                updateStepIndicator(2);
            });
            
            // Submit analysis with validation
            $('#columnsForm').on('submit', function(e) {
                e.preventDefault();
                
                const analysis = $(this).data('analysis');
                
                // Validate selections
                if (!validateSelections()) {
                    if ($('#validationMessage').is(':hidden')) {
                        $('#validationMessage').text('Please correct the errors and try again').show();
                    }
                    return false;
                }
                
                $('#loading').show();
                $('#columnSelection').hide();
                
                const formData = new FormData();
                formData.append('analysis_type', analysis);
                
                // Get all form values
                const formValues = getFormValues();
                
                // Add selected variables to formData based on analysis type requirements
                const requirements = analysisRequirements[analysis];
                
                if (requirements.variables) {
                    requirements.variables.forEach(variable => {
                        const id = variable.id;
                        const value = formValues[id];
                        
                        if (value) {
                            if (Array.isArray(value)) {
                                // Handle multiple selection variables
                                if (id === 'numeric_vars' || id === 'independent_vars') {
                                    // These get mapped to 'columns' for the backend
                                    value.forEach(v => formData.append('columns', v));
                                } else {
                                    value.forEach(v => formData.append(id, v));
                                }
                            } else {
                                // Handle single selection variables
                                formData.append(id, value);
                            }
                        }
                    });
                }
                
                // Add options to formData
                if (requirements.options) {
                    requirements.options.forEach(option => {
                        const id = option.id;
                        
                        if (option.type === 'checkbox') {
                            if (formValues[id]) {
                                formData.append(id, 'true');
                            }
                        } else if (formValues[id] !== undefined) {
                            formData.append(id, formValues[id]);
                        }
                    });
                }
                
                // Special handling for different analysis types
                switch(analysis) {
                    case 'linear_regression':
                        // Map to expected backend params
                        formData.append('dependent_var', formValues.dependent_var);
                        formData.append('columns', formValues.independent_var);
                        break;
                        
                    case 'multiple_regression':
                        // Already handled by the general code above
                        break;
                        
                    case 'polynomial_regression':
                        // Map to expected backend params
                        formData.append('dependent_var', formValues.dependent_var);
                        formData.append('columns', formValues.independent_var);
                        break;
                        
                    case 'anova':
                        // Map grouping_var to expected backend param
                        formData.append('dependent_var', formValues.dependent_var);
                        formData.append('columns', formValues.grouping_var);
                        break;
                        
                    case 'descriptive_statistics':
                        // Add row filtering if enabled
                        if (formValues.filter_rows) {
                            formData.append('start_row', formValues.start_row);
                            formData.append('end_row', formValues.end_row);
                        }
                        break;
                }
                
                $.ajax({
                    url: '/analyze',
                    method: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        $('#loading').hide();
                        
                        if (response.success) {
                            renderResults(analysis, response.result);
                            $('#resultsContainer').show();
                        } else {
                            $('#validationMessage').html(response.message).show();
                            $('#columnSelection').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loading').hide();
                        $('#validationMessage').html('An error occurred: ' + error).show();
                        $('#columnSelection').show();
                    }
                });
            });
            
            // Render results
            function renderResults(analysisType, result) {
                const container = $('#resultsContent').empty();
                $('#resultsTitle').text(analysisType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + ' Results');                
                
                // Handle images if present
                if (result[analysisType] && Array.isArray(result[analysisType])) {
                    result[analysisType].forEach(item => {
                        if (item.image) {
                            container.append(`
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5>${item.title}</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <img src="data:image/png;base64,${item.image}" class="img-fluid result-image" alt="${item.title}">
                                    </div>
                                </div>
                            `);
                        }
                    });
                }          
                
                // Handle statistics if present
                if (result.statistics) {
                    container.append(`
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Descriptive Statistics</h5>
                            </div>
                            <div class="card-body table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Statistic</th>
                                            ${Object.keys(result.statistics).map(stat => 
                                                `<th>${stat}</th>`
                                            ).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${['count', 'mean', 'std', 'min', '25%', '50%', '75%', 'max'].map(metric => 
                                            `<tr>
                                                <th>${metric}</th>
                                                ${Object.keys(result.statistics).map(stat => 
                                                    `<td>${result.statistics[stat][metric] !== undefined ? 
                                                        typeof result.statistics[stat][metric] === 'number' ? 
                                                            result.statistics[stat][metric].toFixed(4) : 
                                                            result.statistics[stat][metric] : 
                                                        'N/A'}</td>`
                                                ).join('')}
                                            </tr>`
                                        ).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `);
                }
                
                // Process any other result types
                for (let key in result) {
                    // Skip already processed parts
                    if (key === 'statistics' || (key === analysisType && Array.isArray(result[key]))) {
                        continue;
                    }
                    
                    if (typeof result[key] === 'object' && !Array.isArray(result[key])) {
                        // For objects like classification_report
                        container.append(`
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h5>
                                </div>
                                <div class="card-body">
                                    <pre class="bg-light p-3 rounded">${JSON.stringify(result[key], null, 2)}</pre>
                                </div>
                            </div>
                        `);
                    } else if (Array.isArray(result[key])) {
                        // For arrays of data
                        container.append(`
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group">
                                        ${result[key].map(item => 
                                            `<li class="list-group-item">${JSON.stringify(item)}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            </div>
                        `);
                    } else {
                        // For simple values
                        container.append(`
                            <div class="alert alert-info">
                                <strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> 
                                ${result[key]}
                            </div>
                        `);
                    }
                }
                
                // Add timestamp
                container.append(`
                    <div class="text-muted mt-4 text-end">
                        <small>Analysis completed: ${new Date().toLocaleString()}</small>
                    </div>
                `);
            }
            
            // Initialize at step 1
            updateStepIndicator(1);
        });
    </script>
</body>
</html>